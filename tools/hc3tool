#!/usr/bin/env lua

--_DEVELOP = true
SCRIPTNAME = "hc3tool"
if require and not QuickApp then require("hc3emu") end
--%%color=false
--%%shellscript=true
--%%silent=true
--%%debug=info:false

local argparse = os.require("argparse")

local function ERROR(fmt,...) print(string.format("Error: "..fmt,...)) os.exit(-1) end

local parser = argparse("hc3tool", "Script to interact with HC3")
parser:command_target("command")

local list = parser:command("list", "List HC3 resources")
list:argument("resource", "Resource type"):choices({"devices","globalVariables","quickApps","scenes","rooms","sections","users","settings","gateways","notifications","plugins","scenes","sections","rooms","globalVariables","gateways","notifications","plugins","settings","users","quickApps"})
list:argument("id", "Resource id"):args("?")
list:flag("-p --pretty", "Pretty print")

local quickApp = parser:command("qa", "QuickApp operations")
quickApp:argument("id", "QuickApp id"):convert(tonumber)
quickApp:argument("file", "QuickApp file"):args("?")
quickApp:option("-f --file", "save to file"):args("?")

local download = parser:command("download", "Download QuickApp or Scene")
download:argument("what", "qa or scene"):choices({"qa","scene"})
download:argument("id", "QuickApp or Scene id"):convert(tonumber)
download:option("-f --file", "save to file"):args("?")

local upload = parser:command("upload", "Upload QuickApp or Scene")
upload:argument("file", "QuickApp or Scene file, .fqa, .scene")

local arg = "list devices 602 -p"
arg = "list globalVariables A -p"
arg = "qa 602"
arg = "qa 602 main"
arg="-h"
arg="download qa 602"
--local args = string.split(arg)

if _DEVELOP then args = string.split(arg) end
args = parser:parse(args)
if _DEVELOP then print(json.encode(args)) end

local function printf(...) _print(string.format(...)) end

local cmds = {}

function cmds.download(args)
  if args.what == "qa" then
    local fqa = api.get("/quickApp/export/"..args.id)
    printf("%s",json.encode(fqa))
  elseif args.what == "scene" then
    local scene = api.get("/scene/"..args.id)
    printf("%s",json.encode(scene))
  end
end

function cmds.unpack(path, savePath)
  __assert_type(path, "string")
  TQ.unpackFQA(path,savePath or "./")
end

function cmds.qa(args)
  local id = args.id
  if not args.file then
    local r = api.get("/quickApp/"..id.."/files")
    for i,v in ipairs(r) do
      printf("%s",v.name)
    end
  elseif args.file then
    local r = api.get("/quickApp/"..id.."/files/"..args.file)
    print(r.content)
  elseif args.save then
    cmds.unpack(id,args.save)
  end
end
function cmds.list(args)
  local rsrc = args.resource
  local id = args.id
  if not id then
    local r = api.get("/"..rsrc)
    for i,v in ipairs(r) do
      printf("%s %s",v.id or v.name or "",v.value or v.name or "")
    end
  else
    local r = api.get("/"..rsrc.."/"..id)
    assert(r, "Resource not found")
    if args.pretty then
      printf("%s", json.encodeFormated(r))
    else
      printf("%s", json.encode(r))
    end
  end
end

function cmds.lua(str)
  __assert_type(str, "string")
  local f,err = fibaro.hc3emu.load(str)
  if not f then
    printf("Error: %s",err)
    return
  end
  local r = {pcall(f)}
  if r[1] then
    for i=2,#r do
      local v = r[i]
      printf("%s",type(v)=='table' and json.encode(v) or v)
    end
  else
    printf("Error: %s",r[2])
  end
end

local stat,err = pcall(function()
  local cmd = args.command
  cmds[cmd](args)
end)
if not stat then ERROR(err) end
os.exit(0)
